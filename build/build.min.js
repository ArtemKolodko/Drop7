function Digit(a,b,c,d){"object"==typeof a?(this.value=a.value||1,this.opened=a.opened||0,this.r=a.r,this.c=a.c):(this.value=c||1,this.opened=d||0,this.r=a,this.c=b),this.view=function(){return 0==this.opened?'<div data-digit="'+this.value+'" class="cell-content numberCircle numberCircle_'+this.value+'"></div>':'<div class="cell-content numberCircle numberCircle_hidden_'+this.opened+'"></div>'},this["class"]=function(){return 0==this.opened?"cell-content numberCircle numberCircle_"+this.value:"cell-content numberCircle numberCircle_hidden_"+this.opened}}function Field(a,b){this.width=a||7,this.height=b||7,this.map=[]}function GameView(a){this.game=a,this.current=null,this.emptyContent='<div class="cell-content"></div>',this.bindActions()}function Game(a){this.field=new Field,this.score=0,this.level=1,this.turns=0,this.turnOn=!0,this.state="in_game",this.score=a.score||0,this.promiseState="waiting",this.startPosition=a.start,this.nextDigit=null,this.view=new GameView(this),this.newGame()}var app=app||{},DROP_TIMEOUT=200,GRAVITY_TIMEOUT=600,NEXT_CHAIN_TIMEOUT=400,START_TIMEOUT=100,NEXT_LEVEL_TIMEOUT=700,GAME_OVER_TIMEOUT=1e3,CLOSED_DIGIT_CHANCE=.27;$.fn.extend({animateCss:function(a,b,c){var d="webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend";$(this).addClass("animated "+a).one(d,function(){$(this).removeClass("animated "+a),b&&b($(this),c)})}}),$(document).ready(function(){app.best={score:0},app.setBest=function(a,b){switch(a){case"score":app.best.score=b}localStorage.setItem("best_"+a,b)},app.readBest=function(){localStorage.getItem("best_score")&&(app.best.score=parseInt(localStorage.getItem("best_score")))},app.startVariants=["0|2|2_0|7_0|5_2|6_3|3_3|7|2_5|4_6|6_6|4_n|5"];var a=localStorage.getItem("last_game")||app.startVariants[0];app.readBest(),app.game=new Game({start:a})}),Field.prototype.initField=function(a,b){if(a&&a.random){this.map=[];for(var c=0;c<this.width;c++){this.map[c]=[];for(var d=0;d<this.height;d++)this.map[c][d]=null}}b&&b(this)},Field.prototype.serialize=function(){var a="";return this.eachCell(function(b,c,d){a.length>0&&(a+="_"),b&&(a+=c+"|"+b.value.toString()+"|"+b.opened.toString())}),a},Field.prototype.pushDigit=function(a,b){for(var c=this.map[a.c].length-1;c>=0;c--)if(null==this.map[a.c][c]){a.r=c,this.map[a.c][c]=new Digit(a);break}b&&b(a)},Field.prototype.digitsForDrop=function(){var a=[],b=this;return this.eachCell(function(c){var d=b.neighbourCross(c);0!=c.opened||d.hor!=c.value&&d.ver!=c.value||a.push(new Digit(c))}),a},Field.prototype.getRandomDigit=function(a){var b={r:"undefined"!=typeof a.row?a.row:1,c:"undefined"!=typeof a.col?a.col:1,value:Math.round(6*Math.random()+1),opened:"undefined"!=typeof a.opened?a.opened:Math.random()<.2?2:0};return new Digit(b)},Field.prototype.proceedNextLevelShift=function(){var a=[],b=[],c=[],d=this;return this.eachCell(function(e,f,g){if(e&&(d.map[e.c][e.r]=null,e.r=e.r-1,d.checkBounds(e)?(d.map[e.c][e.r]=new Digit(e),e.r=e.r+1,a.push(e)):b.push(e)),f==d.width-1){var h=d.getRandomDigit({col:g,row:f,opened:2});d.map[h.c][h.r]=h,c.push(h)}},!0,"start"),{newDigits:c,outOfBounds:b,shifted:a}},Field.prototype.isColumnsInBounds=function(){for(var a=this.columnsStat(),b=0;b<a.length;b++)if(a[b]>7)return!1;return!0},Field.prototype.columnsStat=function(){var a=[],b=0,c=0,d=this;return this.eachCell(function(e,f,g){c!=f&&(c=f,b=0),e&&b++,d.width-1==g&&a.push(b)},!0),a},Field.prototype.havePossibleTurns=function(){var a=this.possibleTurns();return a.length>0},Field.prototype.possibleTurns=function(){var a=[];return this.eachCell(function(b,c,d){b||a.push({x:c,y:d})},!0),a},Field.prototype.proceedGravity=function(){var a=this,b=[];return this.eachCell(function(c){var d=new Digit(c);a.map[c.c][c.r]=null,a.pushDigit(c,function(a){b.push({old:d,"new":new Digit(a)})})}),b},Field.prototype.neighbourCross=function(a){var b=0,c=0;if(a&&0==a.opened){for(var d=a.c-a.value;d<a.c+a.value+1;d++)if(this.checkBounds({c:d,r:a.r})){var e=this.map[d][a.r];if(e)b++;else{if(d>a.c)break;b=0}}for(var f=a.r-a.value;f<a.r+a.value+1;f++)if(this.checkBounds({c:a.c,r:f})){var e=this.map[a.c][f];if(e)c++;else{if(f>a.r)break;c=0}}}return{hor:b,ver:c}},Field.prototype.checkBounds=function(a){return a&&a.r<this.width&&a.r>=0&&a.c<this.height&&a.c>=0},Field.prototype.isFullColumn=function(a){return this.where({c:a}).length==this.height},Field.prototype.where=function(a){var b=[];return this.eachCell(function(c){var d=!0,e=Object.keys(a);if(null!=c){for(var f in e)a.hasOwnProperty(e[f])&&c[e[f]]!=a[e[f]]&&(d=!1);d&&b.push(c)}}),b},Field.prototype.eachCell=function(a,b,c){b="undefined"!=typeof b&&b,c="undefined"!=typeof c?c:"bubble";for(var d=0;d<this.width;d++)if("bubble"==c)for(var e=this.height-1;e>=0;e--){var f=this.map[d][e];(f&&a||b&&a)&&a(f,d,e)}else if("start"==c)for(var e=0;e<this.height;e++){var f=this.map[d][e];(f&&a||b&&a)&&a(f,d,e)}},GameView.prototype.bindActions=function(){var a=this;$(document).on("mouseup",".gameField .cell",function(b){a.game.turnOn&&1==b.which&&a.game.onCellClicked({c:parseInt($(this).attr("data-y"))})}),$(document).on("click",".restart-button",function(){(a.game.turnOn||"game_over"==a.game.state)&&app.game.restartGame()}),$(document).on("mouseover",".gameField .cell",function(){a.game.turnOn})},GameView.prototype.pushDigit=function(a,b,c){var d=this;b?($('.gameField .cell[data-y="'+a.c+'"]').addClass("activeCell"),$(".nextDigit .cell-content").animateCss("top_down top_down_"+a.c+"_"+a.r,function(b){$(".cell.activeCell").removeClass("activeCell");var e=$(".cell[data-x="+a.r+"][data-y="+a.c+"] .cell-content");e.addClass(a["class"]()),0==a.opened&&e.attr("data-digit",a.value),b.parent().html(d.emptyContent),c&&c(a,b)})):$(".cell[data-x="+a.r+"][data-y="+a.c+"]").html(a.view()).find(".cell-content").animateCss("bounceInDown")},GameView.prototype.setNewDigit=function(a){$(".nextDigit.cell").html(a.view()).find(".cell-content").animateCss("bounceIn")},GameView.prototype.updateScore=function(a,b){function c(a){return a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,".")}$(".score .scoreSum").text(c(a))},GameView.prototype.updateTurns=function(a){for(var b="",c=0;c<a.maxTurnsOnLevel;c++)b+='<div class="smallTurn"></div>';$(".turnsIndicator").html(b),a.turns>0&&$(".turnsIndicator .smallTurn:not(.wasted)").slice(-a.turns).addClass("wasted"),$(".levelNumber").text(a.level)},GameView.prototype.shiftBottomOnChangeLevel=function(a){var b=a.outOfBounds.length>0;if(b)var c=[].concat(a.shifted,a.outOfBounds);else c=a.shifted;for(var d in c){var e=c[d];$(".cell[data-x="+e.r+"][data-y="+e.c+"]").html(this.emptyContent),e.r>=0?$(".cell[data-x="+parseInt(e.r-1)+"][data-y="+e.c+"]").html(e.view()).find(".cell-content").animateCss("moveUp",function(a){a.removeClass("moveUp")}):$(".cell[data-x="+parseInt(e.r+1)+"][data-y="+e.c+"]").css("position","relative").append(e.view()).find(".cell-content:last").css({position:"absolute",top:"-50px"}).animateCss("moveUp",function(a){a.removeClass("moveUp")})}for(var f in a.newDigits){var g=a.newDigits[f];$(".cell[data-x="+parseInt(g.r)+"][data-y="+g.c+"]").html(g.view()).find(".cell-content").animateCss("moveUp",function(a){a.removeClass("moveUp")})}},GameView.prototype.digitAction=function(a,b){var c=this;switch(a){case"drop":var d=$(".cell[data-x="+b.digit.r+"][data-y="+b.digit.c+"] .cell-content"),e=d.position(),f=[" #66a1ee","#30e849","#e83a30","#e5d1fa"],g=f[Math.round(Math.random()*f.length)],h='<div class="tempRising" style="position: absolute;top:'+e.top+"px; left:"+e.left+"px; color: "+g+';">+'+b.digitScore+"</div>";$(h).appendTo(".animationWrapper").animateCss("risingPoint",function(a){a.remove()}),d.animateCss("zoomIn",function(a){a.parent().html(c.emptyContent)});for(var i in b.hidden){var j=b.hidden[parseInt(i)],k=$(".cell[data-x="+j.r+"][data-y="+j.c+"] .cell-content");k.animateCss("openDigit openDigit_"+j.opened,function(a,b){a.parent().html(b.view()).find(".cell-content").animateCss("tremors")},j)}break;case"gravity":var l=$(".cell[data-x="+b.old.r+"][data-y="+b.old.c+"] .cell-content");l.animateCss("in_field_down in_field_down_"+parseInt(b["new"].r-b.old.r-1),function(a,b){var d=$(".cell[data-x="+b["new"].r+"][data-y="+b["new"].c+"]");d.empty(),a.clone().appendTo(d),a.parent().html(c.emptyContent)},b)}b.chain&&b.chain>1&&$(".nextDigit .cell-content").text("CHAIN x"+b.chain)},GameView.prototype.onBoardMessage=function(a){switch(a.type){case"new_level_bonus":b='<div class="onBoardMessage">New level bonus +7000</div>';break;case"game_over":b='<div class="onBoardMessage onBoardMessage__gameOver"><p><strong>Game over</strong></p><p>Your score: '+a.score+"</p><p>Best score: "+a.best.score+"</p></div>",$(".nextDigit .cell-content").text("");break;default:var b=""}$(".onBoardMessage").remove(),$(".gameField").prepend(b),$(".onBoardMessage").animateCss("lightSpeedIn",function(b){"new_level_bonus"==a.type&&setTimeout(function(){$(".onBoardMessage").animateCss("lightSpeedOut",function(){$(".onBoardMessage").remove()})},1150)})},GameView.prototype.render=function(a){switch(a.action){case"new":$(".gameField").empty();var b="";for(var c in a.map){b+='<div class="row"></div>';for(var d in a.map[c]){var e=a.map[d][c];if(e)var f='<div data-digit="'+e.value+'" class="cell-content numberCircle numberCircle_'+e.value+'"></div>';else f=this.emptyContent;b+='<div class="cell" data-x="'+c+'" data-y="'+d+'">'+f+"</div>"}}$(".gameField").html(b)}},Game.prototype.serialize=function(){var a=this.field.serialize();return this.nextDigit&&(a+="_n|"+this.nextDigit.value+this.nextDigit.opened),a+="_s|"+this.score,a+="_l|"+this.level,a+="_t|"+this.turns},Game.prototype.onCellClicked=function(a){this.field.isFullColumn(a.c)||(this.turnOn=!1,this.setTurns(this.turns+1),this.createChainOnTurn(a))},Game.prototype.setScore=function(a){this.score+=a,this.score>app.best.score&&app.setBest("score",this.score),this.view.updateScore(this.score,app.best.score)},Game.prototype.setTurns=function(a){this.turns=a,this.view.updateTurns({turns:this.turns,level:this.level,maxTurnsOnLevel:this.getMaxTurnsOnLevel()})},Game.prototype.isGameOver=function(){var a=this.field.havePossibleTurns(),b=this.field.isColumnsInBounds();return!a||!b},Game.prototype.actionsAfterChain=function(){return{nextLevel:!this.isGameOver()&&this.getMaxTurnsOnLevel()==this.turns,haveTurns:!this.isGameOver(),emptyField:this.field.possibleTurns().length==this.field.width*this.field.height}},Game.prototype.getMaxTurnsOnLevel=function(){return this.level<23?30-this.level:7},Game.prototype.createChainOnTurn=function(a){var b=this,c=new Digit(this.nextDigit);c.c=a.c,this.field.pushDigit(c,function(a){b.view.pushDigit(a,!0,function(){b.chainPromise()})})},Game.prototype.onDigitDrop=function(a,b,c){var d=this.level<10?2:3,e=Math.pow(7,d),f=(c-1)*e+7*this.level;this.setScore(f),this.view.digitAction("drop",{digit:a,hidden:b,digitScore:f,chain:c})},Game.prototype.chainPromise=function(){for(var a=[],b=this;this.field.digitsForDrop().length>0;)a.push(this.proceedStep());for(var c=new Promise(function(a,b){setTimeout(function(){console.log("start"),a()},START_TIMEOUT)}),d=0;d<a.length;d++){var e=function(c){return function(){return new Promise(function(d,e){setTimeout(function(){for(var e in a[c].drop)b.onDigitDrop(a[c].drop[e],a[c].hidden,c+1);d()},DROP_TIMEOUT)})}}(d),f=function(c){return function(){return new Promise(function(d,e){setTimeout(function(){for(var e in a[c].gravity){var f=a[c].gravity[e];f.old.r==f["new"].r&&f.old.c==f["new"].c||b.view.digitAction("gravity",f)}d()},GRAVITY_TIMEOUT)})}}(d);c=c.then(e),c=c.then(f),a.length>0&&d<a.length-1&&(c=c.then(function(){return new Promise(function(a,b){setTimeout(function(){a()},NEXT_CHAIN_TIMEOUT)})}))}var g=this.actionsAfterChain();if(g.nextLevel){var h=this.field.proceedNextLevelShift();if(h.outOfBounds.length>0)return void(c=c.then(function(){return new Promise(function(a,c){setTimeout(function(){b.view.shiftBottomOnChangeLevel(h),b.goToNextLevel(!1),b.setGameOver(),a()},GAME_OVER_TIMEOUT)})}));c=c.then(function(){return new Promise(function(a,c){setTimeout(function(){return b.goToNextLevel(!0),b.view.shiftBottomOnChangeLevel(h),b.field.digitsForDrop().length>0?(setTimeout(function(){b.chainPromise()},NEXT_CHAIN_TIMEOUT),void c("Another chain after move Up")):void a()},NEXT_LEVEL_TIMEOUT)})})}else{if(!g.haveTurns)return void(c=c.then(function(){return new Promise(function(a,c){setTimeout(function(){b.setGameOver(),a()},GAME_OVER_TIMEOUT)})}));g.emptyField}c=c.then(function(){b.setNextDigit(),b.turnOn=!0})["catch"](function(a){console.log("In promise",a)})},Game.prototype.setGameOver=function(){this.state="game_over",localStorage.removeItem("last_game"),this.view.onBoardMessage({type:"game_over",score:this.score,best:app.best})},Game.prototype.saveGame=function(){localStorage.setItem("last_game",this.serialize())},Game.prototype.goToNextLevel=function(a){this.level++,this.setTurns(0),a&&(this.setScore(7e3*(this.level-1)),this.view.onBoardMessage({type:"new_level_bonus"}))},Game.prototype.setNextDigit=function(a,b){"undefined"==typeof b&&(b=0);var c={row:null,col:2,value:a?a:Math.round(6*Math.random()+1),opened:a?b:Math.random()<CLOSED_DIGIT_CHANCE?2:0};this.nextDigit=new Digit(c),this.saveGame(),this.view.setNewDigit(this.nextDigit)},Game.prototype.proceedStep=function(){var a=this.field.digitsForDrop(),b=[[-1,0],[0,-1],[1,0],[0,1]],c=[];for(var d in a){var e=a[d];this.field.map[e.c][e.r]=null;for(var f in b){var g=e.c+b[f][0],h=e.r+b[f][1];if(this.field.checkBounds({c:g,r:h})){var i=this.field.map[g][h];if(i&&i.opened>0){if(1===i.opened)for(var j=0;j<c.length;j++){var k=c[j];k.r===i.r&&k.c===i.c&&k.value===i.value&&c.splice(j,1)}this.field.map[g][h].opened--,c.push(new Digit(i))}}}}var l=this.field.proceedGravity();return{drop:a,gravity:l,hidden:c,map:JSON.stringify(this.field.map)}},Game.prototype.restartGame=function(){this.startPosition=app.startVariants[0],this.newGame(),this.turnOn=!0},Game.prototype.newGame=function(a){this.state="in_game";var b=this,c=[],d=null,e=0,f=0,g=0,h=1;this.startPosition.split("_").forEach(function(a){var b=a.split("|");switch(b[0]){case"n":d=parseInt(b[1][0]),e=parseInt(b[1][1]);break;case"s":f=parseInt(b[1]);break;case"t":g=parseInt(b[1]);break;case"l":h=parseInt(b[1]);break;default:isNaN(parseInt(b[0]))||c.push({c:parseInt(b[0]),value:parseInt(b[1]),opened:parseInt(b[2])})}}),this.level=h,this.setTurns(g),this.score=f?f:0,this.view.updateScore(this.score),this.field.initField({random:!0},function(a){b.view.render({action:"new",map:a.map});var f=c;for(var g in f)b.field.pushDigit(new Digit(f[g]),function(a){b.view.pushDigit(a)});b.setNextDigit(d,e)})};
//# sourceMappingURL=build.min.js.map